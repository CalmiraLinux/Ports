#!/bin/bash
#
# Скрипт для обновления портов в Calmira Linux
# (C) 2021 Linuxoid85 <linuxoid85@gmail.com>
#

source /etc/cpkg/system.version

# Setting up a ports utility locale
if [ -z $LANG ]; then
	if [ -z $LC_ALL ]; then
		echo -e "\e[1;31mERROR: \e[35m\$LC_ALL\e[0m\e[1;31m and \e[0m\e[35m\$LANG\e[0m\e[1;31m variables DOESNT EXISTS! \e[0m"
		exit 1
	else
		export LANG=$LC_ALL
	fi
fi

if [ -f "/usr/share/cpkg/locale/$LANG.sh" ]; then
	source /usr/share/cpkg/locale/$LANG.sh
else
	echo -e "\e[1;31mERROR: locale $LANG.sh doesn't exists!"
	export LANG=ru_RU-UTF-8			# Export default variable
	if [ -f /usr/share/cpkg/locale/$LANG.sh ]; then
		source /usr/share/locale/$LANG.sh	# Source default locale file
	else
		exit 1
	fi
fi

export NAME_FUNCTION="update_ports"

case $1 in
	stable)
		echo -e "\e[1mОбновление портов со стабильной ветки...\e[0m"
		
		cd /var/cache/cpkg/archives
		
		# Если порты ранее уже скачивались, то удалить директорию с ними
		if [ -d "ports" ]; then
			rm -rf ports
		fi
		
		wget https://gitlab.com/Linuxoid85/calmira_ports/-/raw/main/ports-lx4_1.0.txz
		if [ -f "ports-lx4_1.0.txz" ]; then
			tar -xf ports-lx4_1.0.txz
		else
			echo -e "\e[1m$ERROR $UNPACK_FAIL1 $DOWNLOAD_PKG_FAIL\e[0m"
			log_msg "Error downloading ports package!" "EMERG" "/var/log/port_system.log"
			exit 1
		fi
		
		# Проверка на корректность распаковки файла
		if [ -d "ports" ]; then
			log_msg "Unpacking ports package DONE" "OK" "/var/log/port_system.log"
		else
			echo -e "\e[1;31m$ERROR $UNPACK_FAIL1 \e[0m\e[35mCalmira port system\e[0m\e[1;31m $UNPACK_FAIL2\e[0m"
			log_msg "Unpacking ports package FAIL" "EMERG" "/var/log/port_system.log"
			
			exit 1
		fi
		
		# Если порты уже установлены (это поведение по умолчанию), то
		# переместить их в папку со случайным номером на конце
		log_msg "Move old port dir..." "Process" "/var/log/port_system.log"
		mv -v /usr/ports /usr/"ports-$RANDOM" >> /var/log/port_system.log
		
		# Копирование файла
		log_msg "Move new port files..." "Process" "/var/log/port_system.log"
		cp -v ports /usr >> /var/log/port_system.log
		
		# Удаление неиспользуемых файлов
		log_msg "Remove temp files..." "Process" "/var/log/port_system.log"
		rm -fv /usr/ports/{update-ports,README.md} >> /var/log/port_system.log
	;;
	
	testing)
		echo -e "\e[1;31mНа данный момент тестовой ветки не существует.\e[0m"
		exit 1
	;;
esac
